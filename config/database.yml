# PostgreSQL configuration optimized for high concurrency (2000+ users)
#
# Connection Pool Sizing:
# - pool should be >= RAILS_MAX_THREADS per process
# - For production with Puma: pool = max_threads * workers + overhead
# - Action Cable connections also need pool connections

default: &default
  adapter: postgresql
  encoding: unicode
  # Pool size: should accommodate threads + Action Cable connections
  # Formula: (RAILS_MAX_THREADS * WEB_CONCURRENCY) + Action Cable overhead
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 }.to_i + 5 %>
  
  # Connection timeout in milliseconds
  checkout_timeout: 5
  
  # Statement timeout to prevent long-running queries (30 seconds)
  variables:
    statement_timeout: 30000
  
  # Enable prepared statements for better query performance
  prepared_statements: true

development:
  <<: *default
  database: flikk_app_development

test:
  <<: *default
  database: flikk_app_test

production:
  <<: *default
  database: flikk_app_production
  username: flikk_app
  password: <%= ENV["FLIKK_APP_DATABASE_PASSWORD"] %>
  
  # Larger pool for production with Action Cable
  pool: <%= ENV.fetch("DATABASE_POOL_SIZE") { 20 } %>
  
  # Use DATABASE_URL if provided (Fly.io sets this)
  url: <%= ENV["DATABASE_URL"] %>
  
  # Reaping frequency in seconds (clean up dead connections)
  reaping_frequency: 10
  
  # Idle timeout in seconds
  idle_timeout: 300
