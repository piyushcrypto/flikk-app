<%# Message bubble partial %>
<% is_own = message.from?(current_user) %>
<% reaction_counts = message.reaction_counts %>

<div class="flex <%= is_own ? 'justify-end' : 'justify-start' %> group" data-message-id="<%= message.id %>">
  <% unless is_own %>
    <div class="flex-shrink-0 mr-2">
      <div class="w-8 h-8 rounded-full overflow-hidden">
        <% if message.sender.avatar.attached? %>
          <%= image_tag message.sender.avatar, class: "w-full h-full object-cover" %>
        <% else %>
          <div class="w-full h-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center">
            <span class="text-white font-bold text-xs"><%= message.sender.name.first.upcase %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <div class="relative">
    <div class="message-bubble <%= is_own ? 'sent' : 'received' %> rounded-2xl px-4 py-2 <%= is_own ? 'text-white' : 'text-white' %>">
      <% unless is_own %>
        <p class="text-xs text-pink-400 mb-1"><%= message.sender.name %></p>
      <% end %>
      <p class="text-sm whitespace-pre-wrap"><%= message.content %></p>
      <p class="text-xs opacity-70 mt-1">
        <%= message.created_at.strftime('%H:%M') %>
        <% if is_own && message.read? %>
          <span class="ml-1">✓✓</span>
        <% end %>
      </p>
    </div>

    <%# Reaction bar - show existing reactions %>
    <% if reaction_counts.any? %>
      <div class="reaction-bar flex flex-wrap gap-1 mt-1 <%= is_own ? 'justify-end' : 'justify-start' %>" data-reactions-container>
        <% reaction_counts.each do |emoji, count| %>
          <button 
            class="reaction-pill flex items-center gap-0.5 px-2 py-0.5 rounded-full text-xs bg-gray-700/80 hover:bg-gray-600 transition-colors <%= message.reacted_by?(current_user, emoji) ? 'ring-1 ring-pink-500' : '' %>"
            data-emoji="<%= emoji %>"
            data-message-id="<%= message.id %>"
            onclick="toggleReaction(this)"
          >
            <span><%= emoji %></span>
            <span class="text-gray-300" data-count><%= count %></span>
          </button>
        <% end %>
      </div>
    <% end %>

    <%# Reaction picker - appears on hover %>
    <div class="reaction-picker absolute <%= is_own ? 'right-0' : 'left-0' %> bottom-full mb-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none group-hover:pointer-events-auto z-10">
      <div class="bg-gray-800/95 backdrop-blur-sm rounded-full px-2 py-1 flex gap-1 shadow-lg border border-gray-700">
        <% MessageReaction::ALLOWED_EMOJIS.each do |emoji| %>
          <button 
            class="reaction-btn hover:scale-125 transition-transform text-lg p-1"
            data-emoji="<%= emoji %>"
            data-message-id="<%= message.id %>"
            onclick="toggleReaction(this)"
            title="React with <%= emoji %>"
          >
            <%= emoji %>
          </button>
        <% end %>
      </div>
    </div>
  </div>
</div>
