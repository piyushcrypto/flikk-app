<%# Message bubble partial - WhatsApp style %>
<% is_own = message.from?(current_user) %>
<% reaction_counts = message.reaction_counts %>

<div class="message-row flex <%= is_own ? 'justify-end' : 'justify-start' %>" data-message-id="<%= message.id %>">
  <%# Avatar for received messages %>
  <% unless is_own %>
    <div class="flex-shrink-0 mr-2 self-end">
      <div class="w-8 h-8 rounded-full overflow-hidden">
        <% if message.sender.avatar.attached? %>
          <%= image_tag message.sender.avatar, class: "w-full h-full object-cover" %>
        <% else %>
          <div class="w-full h-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center">
            <span class="text-white font-bold text-xs"><%= message.sender.name.first.upcase %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <div class="message-wrapper relative max-w-[75%] sm:max-w-[65%]">
    <%# Message bubble %>
    <div class="message-bubble <%= is_own ? 'sent' : 'received' %> rounded-2xl px-4 py-2 text-white relative">
      <% unless is_own %>
        <p class="text-xs text-pink-400 mb-1 font-medium"><%= message.sender.name %></p>
      <% end %>
      <p class="text-sm whitespace-pre-wrap break-words"><%= message.content %></p>
      <div class="flex items-center justify-end gap-1 mt-1">
        <span class="text-xs opacity-60"><%= message.created_at.strftime('%H:%M') %></span>
        <% if is_own && message.read? %>
          <span class="text-xs text-blue-400">✓✓</span>
        <% elsif is_own %>
          <span class="text-xs opacity-50">✓</span>
        <% end %>
      </div>
      
      <%# WhatsApp-style reaction trigger button - appears on hover %>
      <button 
        class="reaction-trigger absolute <%= is_own ? '-left-8' : '-right-8' %> top-1/2 -translate-y-1/2 w-7 h-7 rounded-full bg-gray-700/90 hover:bg-gray-600 flex items-center justify-center opacity-0 hover:opacity-100 transition-all shadow-lg"
        onclick="openReactionPicker(this, <%= message.id %>)"
        data-message-id="<%= message.id %>"
      >
        <svg class="w-4 h-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
    </div>

    <%# Reaction bar - show existing reactions %>
    <% if reaction_counts.any? %>
      <div class="reaction-bar flex flex-wrap gap-1 mt-1 <%= is_own ? 'justify-end' : 'justify-start' %>" data-reactions-container>
        <% reaction_counts.each do |emoji, count| %>
          <button 
            class="reaction-pill inline-flex items-center gap-0.5 px-2 py-0.5 rounded-full text-xs bg-gray-700/80 hover:bg-gray-600 transition-colors <%= message.reacted_by?(current_user, emoji) ? 'ring-1 ring-pink-500 bg-pink-900/30' : '' %>"
            data-emoji="<%= emoji %>"
            data-message-id="<%= message.id %>"
            onclick="toggleReaction(this)"
          >
            <span><%= emoji %></span>
            <span class="text-gray-300" data-count><%= count %></span>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<%# Floating reaction picker (hidden by default, shown on click) %>
<div id="reaction-picker-<%= message.id %>" class="reaction-picker-modal hidden fixed z-50" data-message-id="<%= message.id %>">
  <div class="bg-gray-800/95 backdrop-blur-md rounded-2xl p-2 shadow-2xl border border-gray-700">
    <div class="flex gap-1">
      <% MessageReaction::ALLOWED_EMOJIS.each do |emoji| %>
        <button 
          class="reaction-btn w-10 h-10 flex items-center justify-center text-2xl hover:scale-125 hover:bg-gray-700 rounded-full transition-all"
          data-emoji="<%= emoji %>"
          data-message-id="<%= message.id %>"
          onclick="selectReaction(this, '<%= emoji %>', <%= message.id %>)"
        >
          <%= emoji %>
        </button>
      <% end %>
    </div>
  </div>
</div>
