<%# Message bubble partial - WhatsApp style %>
<% is_own = message.from?(current_user) %>
<% reaction_counts = message.reaction_counts %>

<div class="message-row flex <%= is_own ? 'justify-end' : 'justify-start' %> items-end gap-1" data-message-id="<%= message.id %>">
  <%# Reaction button - LEFT side for own messages %>
  <% if is_own %>
    <button 
      class="reaction-trigger flex-shrink-0 w-7 h-7 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-all hover:scale-110"
      onclick="openReactionPicker(this, <%= message.id %>)"
      data-message-id="<%= message.id %>"
      title="React"
    >
      <span class="text-sm">ðŸ˜Š</span>
    </button>
  <% end %>

  <%# Avatar for received messages %>
  <% unless is_own %>
    <div class="flex-shrink-0">
      <div class="w-8 h-8 rounded-full overflow-hidden">
        <% if message.sender.avatar.attached? %>
          <%= image_tag message.sender.avatar, class: "w-full h-full object-cover" %>
        <% else %>
          <div class="w-full h-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center">
            <span class="text-white font-bold text-xs"><%= message.sender.name.first.upcase %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <div class="message-wrapper max-w-[70%] sm:max-w-[65%]">
    <%# Message bubble %>
    <div class="message-bubble <%= is_own ? 'sent' : 'received' %> rounded-2xl px-4 py-2 text-white">
      <% unless is_own %>
        <p class="text-xs text-pink-400 mb-1 font-medium"><%= message.sender.name %></p>
      <% end %>
      <p class="text-sm whitespace-pre-wrap break-words"><%= message.content %></p>
      <div class="flex items-center justify-end gap-1 mt-1">
        <span class="text-xs opacity-60"><%= message.created_at.strftime('%H:%M') %></span>
        <% if is_own && message.read? %>
          <span class="text-xs text-blue-400">âœ“âœ“</span>
        <% elsif is_own %>
          <span class="text-xs opacity-50">âœ“</span>
        <% end %>
      </div>
    </div>

    <%# Reaction bar - show existing reactions (centered below bubble) %>
    <% if reaction_counts.any? %>
      <div class="reaction-bar flex flex-wrap gap-1 mt-1 justify-center" data-reactions-container>
        <% reaction_counts.each do |emoji, count| %>
          <button 
            class="reaction-pill inline-flex items-center gap-0.5 px-2 py-0.5 rounded-full text-xs bg-gray-700/80 hover:bg-gray-600 transition-colors <%= message.reacted_by?(current_user, emoji) ? 'ring-1 ring-pink-500 bg-pink-900/30' : '' %>"
            data-emoji="<%= emoji %>"
            data-message-id="<%= message.id %>"
            onclick="toggleReaction(this)"
          >
            <span><%= emoji %></span>
            <span class="text-gray-300" data-count><%= count %></span>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Reaction button - RIGHT side for received messages %>
  <% unless is_own %>
    <button 
      class="reaction-trigger flex-shrink-0 w-7 h-7 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-all hover:scale-110"
      onclick="openReactionPicker(this, <%= message.id %>)"
      data-message-id="<%= message.id %>"
      title="React"
    >
      <span class="text-sm">ðŸ˜Š</span>
    </button>
  <% end %>
</div>

<%# Floating reaction picker (hidden by default, shown on click) %>
<div id="reaction-picker-<%= message.id %>" class="reaction-picker-modal hidden fixed z-50" data-message-id="<%= message.id %>">
  <div class="bg-gray-800 rounded-2xl p-2 shadow-2xl border border-gray-700 max-w-[90vw]">
    <div class="flex gap-1 overflow-x-auto">
      <% MessageReaction::ALLOWED_EMOJIS.each do |emoji| %>
        <button 
          class="reaction-btn flex-shrink-0 w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-xl sm:text-2xl hover:scale-110 hover:bg-gray-700 rounded-full transition-all"
          data-emoji="<%= emoji %>"
          data-message-id="<%= message.id %>"
          onclick="selectReaction(this, '<%= emoji %>', <%= message.id %>)"
        >
          <%= emoji %>
        </button>
      <% end %>
    </div>
  </div>
</div>
