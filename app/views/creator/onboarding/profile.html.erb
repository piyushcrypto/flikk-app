<%# Creator Onboarding - Step 1: Profile %>
<div class="min-h-screen bg-[#0a0a0a] py-8 px-4">
  <div class="max-w-2xl mx-auto">
    
    <!-- Logo -->
    <div class="text-center mb-8">
      <%= link_to root_path, class: "inline-flex items-center space-x-2" do %>
        <%= render 'shared/logo_icon', size: 'md' %>
        <span class="logo-text text-2xl bg-gradient-to-r from-pink-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">flik<span class="mirror-k" style="background: inherit; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">k</span></span>
      <% end %>
    </div>
    
    <!-- Progress -->
    <%= render 'creator/onboarding/progress' %>
    
    <!-- Card -->
    <div class="bg-[#1a1a1a] rounded-2xl border border-gray-800 p-8">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-white mb-2">Set Up Your Profile</h1>
        <p class="text-gray-400">Let's create your unique creator identity</p>
      </div>
      
      <%= form_with model: current_user, url: creator_onboarding_profile_path, method: :patch, local: true, html: { multipart: true }, class: "space-y-6" do |f| %>
        
        <!-- Profile Picture Upload -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-3">Profile Picture <span class="text-pink-500">*</span></label>
          <div class="flex items-center space-x-6">
            <!-- Avatar Preview -->
            <div class="relative">
              <div id="avatar-preview" class="w-24 h-24 rounded-full overflow-hidden border-2 border-gray-700 bg-[#0a0a0a] flex items-center justify-center">
                <% if current_user.avatar.attached? %>
                  <%= image_tag current_user.avatar, class: "w-full h-full object-cover" %>
                <% else %>
                  <svg class="w-12 h-12 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                <% end %>
              </div>
              <% if current_user.avatar.attached? %>
                <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center border-2 border-[#1a1a1a]">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              <% end %>
            </div>
            
            <!-- Upload Button -->
            <div class="flex-1">
              <label class="cursor-pointer">
                <div class="py-3 px-4 bg-[#0a0a0a] border border-gray-700 border-dashed rounded-xl text-center hover:border-pink-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm text-gray-400">Click to upload photo</span>
                  <p class="text-xs text-gray-600 mt-1">JPG, PNG, GIF up to 5MB</p>
                </div>
                <%= f.file_field :avatar, 
                    accept: "image/jpeg,image/png,image/gif,image/webp",
                    id: "avatar-input",
                    class: "hidden" %>
              </label>
            </div>
          </div>
          <% if current_user.errors[:avatar].any? %>
            <p class="text-xs text-red-400 mt-2"><%= current_user.errors[:avatar].first %></p>
          <% end %>
        </div>
        
        <!-- Instagram Handle -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Instagram Handle</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">@</span>
            <%= f.text_field :instagram_handle, 
                value: current_user.instagram_handle,
                placeholder: "yourhandle",
                class: "w-full bg-[#0a0a0a] border border-gray-700 rounded-xl py-3 pl-10 pr-4 text-white placeholder-gray-600 focus:outline-none focus:border-pink-500 transition-colors" %>
          </div>
          <p class="text-xs text-gray-500 mt-2">Your Instagram for verification (required)</p>
          <% if current_user.errors[:instagram_handle].any? %>
            <p class="text-xs text-red-400 mt-1"><%= current_user.errors[:instagram_handle].first %></p>
          <% end %>
        </div>
        
        <!-- Username -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">@</span>
            <%= f.text_field :username, 
                value: @suggested_username,
                id: "username-input",
                placeholder: "username",
                class: "w-full bg-[#0a0a0a] border border-gray-700 rounded-xl py-3 pl-10 pr-12 text-white placeholder-gray-600 focus:outline-none focus:border-pink-500 transition-colors" %>
            <div id="username-status" class="absolute right-4 top-1/2 -translate-y-1/2">
              <!-- Status icon will be inserted here -->
            </div>
          </div>
          <p id="username-message" class="text-xs text-gray-500 mt-2">This will be your unique flikk URL</p>
          <% if current_user.errors[:username].any? %>
            <p class="text-xs text-red-400 mt-1"><%= current_user.errors[:username].first %></p>
          <% end %>
        </div>
        
        <!-- Bio -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Bio <span class="text-gray-600">(optional)</span></label>
          <%= f.text_area :bio,
              value: current_user.bio,
              rows: 3,
              maxlength: 300,
              placeholder: "Tell fans what makes you unique...",
              class: "w-full bg-[#0a0a0a] border border-gray-700 rounded-xl py-3 px-4 text-white placeholder-gray-600 focus:outline-none focus:border-pink-500 transition-colors resize-none" %>
          <p class="text-xs text-gray-500 mt-2 text-right"><span id="bio-count">0</span>/300</p>
        </div>
        
        <!-- Submit -->
        <div class="pt-4">
          <%= f.submit "Continue â†’", class: "w-full py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-xl hover:opacity-90 transition-opacity cursor-pointer" %>
        </div>
      <% end %>
    </div>
    
  </div>
</div>

<script>
document.addEventListener('turbo:load', () => {
  const usernameInput = document.getElementById('username-input');
  const usernameStatus = document.getElementById('username-status');
  const usernameMessage = document.getElementById('username-message');
  const bioTextarea = document.querySelector('textarea[name="user[bio]"]');
  const bioCount = document.getElementById('bio-count');
  const avatarInput = document.getElementById('avatar-input');
  const avatarPreview = document.getElementById('avatar-preview');
  
  let debounceTimer;
  
  // Avatar preview
  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          avatarInput.value = '';
          return;
        }
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          alert('Please upload a JPEG, PNG, GIF, or WEBP image');
          avatarInput.value = '';
          return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = (event) => {
          avatarPreview.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-cover" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    });
  }
  
  // Username validation
  if (usernameInput) {
    usernameInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      const username = usernameInput.value.trim();
      
      if (username.length < 3) {
        usernameStatus.innerHTML = '';
        usernameMessage.textContent = 'Username must be at least 3 characters';
        usernameMessage.className = 'text-xs text-gray-500 mt-2';
        return;
      }
      
      // Show loading
      usernameStatus.innerHTML = '<svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      
      debounceTimer = setTimeout(() => {
        fetch(`/creator/onboarding/check_username?username=${encodeURIComponent(username)}`)
          .then(res => res.json())
          .then(data => {
            if (data.available) {
              usernameStatus.innerHTML = '<svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>';
              usernameMessage.textContent = data.message;
              usernameMessage.className = 'text-xs text-green-500 mt-2';
            } else {
              usernameStatus.innerHTML = '<svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';
              usernameMessage.textContent = data.message;
              usernameMessage.className = 'text-xs text-red-500 mt-2';
            }
          })
          .catch(() => {
            usernameStatus.innerHTML = '';
            usernameMessage.textContent = 'Error checking username';
            usernameMessage.className = 'text-xs text-red-500 mt-2';
          });
      }, 500);
    });
  }
  
  // Bio character count
  if (bioTextarea && bioCount) {
    bioTextarea.addEventListener('input', () => {
      bioCount.textContent = bioTextarea.value.length;
    });
    bioCount.textContent = bioTextarea.value.length;
  }
});
</script>

